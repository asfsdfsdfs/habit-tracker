<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ultimate Habit Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f6f8fa;
      --card: #fff;
      --accent: #52a7e7;
      --high: #e75480;
      --text: #222;
      --success: #8ed18e;
      --warning: #ffe066;
      --cat1: #ffd966;
      --cat2: #7ec7fb;
      --cat3: #8ed18e;
      --cat4: #e75480;
      --cat5: #b895f8;
      --cat6: #aaa;
    }
    [data-theme="dark"] {
      --bg: #23272f;
      --card: #323841;
      --accent: #7ec7fb;
      --high: #e75480;
      --text: #f6f7fb;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      transition: background .2s, color .2s;
    }
    .container {
      max-width: 500px;
      margin: 32px auto;
      background: var(--card);
      box-shadow: 0 4px 18px #0002;
      border-radius: 18px;
      padding: 28px 16px 36px 16px;
    }
    h1 {
      color: var(--accent);
      text-align: center;
      font-size: 2em;
      margin-bottom: 8px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0;
    }
    #theme-toggle {
      background: var(--accent);
      color: var(--card);
      border: none;
      border-radius: 18px;
      font-size: 0.9em;
      padding: 5px 13px;
      font-weight: bold;
      margin-top: 7px;
      box-shadow: 0 2px 6px #eee;
      cursor: pointer;
    }
    #add-form {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: end;
    }
    #add-form input, #add-form select {
      flex: 1;
      padding: 8px;
      border-radius: 7px;
      border: 1px solid #ddd;
      font-size: 1em;
      background: #fafbfc;
      margin-bottom: 3px;
    }
    #add-form .color-inp {
      width: 38px;
      padding: 4px;
      border-radius: 5px;
      background: #fafbfc;
      border: 1px solid #eee;
    }
    #add-form button {
      background: var(--accent);
      color: var(--card);
      border: none;
      border-radius: 8px;
      font-weight: bold;
      padding: 9px 16px;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 2px 6px #eee;
    }
    .btn-bar {
      margin-bottom: 12px;
    }
    .btn-bar button, .btn-bar label {
      margin-right: 9px;
      margin-bottom: 8px;
    }
    #csv-import {
      display: none;
    }
    .import-btn {
      background: #b895f8;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      padding: 8px 18px;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 2px 6px #eee;
    }
    .export-btn {
      background: #4ba995;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      padding: 8px 18px;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 2px 6px #eee;
    }
    #reset-all {
      background: #bbb; color: var(--card); border-radius: 8px;
      font-weight: bold; padding: 8px 18px; border: none;
      cursor: pointer;
      margin-bottom:6px;
      margin-right:0;
    }
    #reminder-set {
      background: #ffd966; color: #222; border-radius: 8px;
      font-weight: bold; padding: 8px 15px; border: none;
      cursor: pointer;
      margin-bottom:6px; margin-right:0;
    }
    #habits-list {
      margin-bottom: 20px;
    }
    .habit-card {
      background: #fcfcfc;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 14px 12px;
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
    }
    .habit-title {
      font-weight: bold;
      font-size: 1.15em;
      margin-bottom: 4px;
      color: var(--accent);
      display: inline-block;
    }
    .habit-cat {
      font-size: 0.95em;
      font-weight: 500;
      padding: 2px 14px;
      border-radius: 8px;
      margin-left: 11px;
      background: #eee;
      color: #333;
      vertical-align: text-top;
      border: 1px solid #ccc;
    }
    .delete-btn, .reset-btn {
      background: var(--high);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.98em;
      margin-left: 10px;
      cursor: pointer;
    }
    .reset-btn {
      background: #bbb;
      color: var(--card);
      margin-left: 0;
      margin-right: 8px;
    }
    .calendar-row {
      display: flex;
      gap: 2px;
      margin-top: 4px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .cal-cell {
      width: 22px;
      height: 22px;
      background: #eee;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2px;
      cursor: pointer;
      font-size: 1em;
      user-select: none;
      border: none;
      outline: none;
      transition: background 0.15s, color 0.15s;
    }
    .cal-cell.done {
      background: var(--accent);
      color: #fff;
      font-weight: bold;
    }
    .streak {
      font-size: 1em;
      color: var(--success);
      font-weight: bold;
      margin-bottom: 7px;
      margin-top: 6px;
    }
    .sparkline {
      height:28px;
      margin-top:3px;
      margin-bottom:4px;
    }
    .analytics {
      background: #fafbfc;
      border-radius: 12px;
      padding: 18px;
      margin: 22px 0 15px 0;
      box-shadow: 0 2px 8px #eee;
      font-size: 1.04em;
    }
    .donate-btn {
      display: inline-block;
      padding: 8px 20px;
      background: #ffdd67;
      color: #444;
      border-radius: 9px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 2px 6px #eee;
      margin-top: 16px;
      font-size: 1.18em;
    }
    @media (max-width:560px){
      .container{margin:14px 3px;}
      h1{font-size:1.3em;}
      #add-form {flex-direction:column; gap:6px;}
      #main-container {padding: 11px 2px;}
    }
  </style>
</head>
<body>
  <div class="container" id="main-container">
    <div class="top-bar">
      <h1>üî• Habit Tracker Pro</h1>
      <button id="theme-toggle">üåô</button>
    </div>
    <form id="add-form">
      <input type="text" id="habit-input" placeholder="New habit..." maxlength="32" required />
      <select id="cat-input">
        <option value="Health" data-color="var(--cat3)">üçè Health</option>
        <option value="Work" data-color="var(--cat2)">üíª Work</option>
        <option value="Study" data-color="var(--cat5)">üìö Study</option>
        <option value="Sport" data-color="var(--cat4)">üèÉ‚Äç‚ôÇÔ∏è Sport</option>
        <option value="Food" data-color="var(--cat1)">ü•ó Food</option>
        <option value="Other" data-color="var(--cat6)">üß© Other</option>
      </select>
      <input class="color-inp" type="color" id="custom-color" value="#52a7e7" title="Custom color" />
      <button type="submit">Add</button>
    </form>
    <div class="btn-bar">
      <button class="export-btn" onclick="exportCSV()">Export CSV</button>
      <label class="import-btn" for="csv-import">Import CSV</label>
      <input id="csv-import" type="file" accept=".csv" />
      <button id="reset-all" onclick="resetAllHabits()">Reset All</button>
      <button id="reminder-set" onclick="setReminder()">Set Daily Reminder</button>
    </div>
    <div id="habits-list"></div>
    <div class="analytics" id="analytics"></div>
    <div style="text-align:center;">
      <a class="donate-btn" href="https://www.buymeacoffee.com/" target="_blank" rel="noopener">‚òï Support Me</a>
    </div>
  </div>
  <script>
    const habitsKey = 'habit_tracker_vUltimate';
    let habits = [];

    // THEME
    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem('habit_theme', theme);
      document.getElementById('theme-toggle').textContent = theme === "dark" ? "üåû" : "üåô";
    }
    document.getElementById("theme-toggle").onclick = () => {
      let curr = document.documentElement.getAttribute("data-theme");
      setTheme(curr === "dark" ? "light" : "dark");
    };
    setTheme(localStorage.getItem("habit_theme") || "light");

    // Custom habit color selector logic
    document.getElementById("cat-input").onchange = function() {
      let selected = this.options[this.selectedIndex];
      let color = selected.getAttribute("data-color") || "#52a7e7";
      document.getElementById("custom-color").value = rgb2hex(window.getComputedStyle(document.documentElement).getPropertyValue(color.replace("var(", "").replace(")", "").trim()));
    }
    function rgb2hex(rgb){
      if(!rgb) return "#52a7e7";
      rgb = rgb.replace(/[^\d,]/g, '').split(',');
      return "#" + ((1 << 24) + (+rgb[0] << 16) + (+rgb[1] << 8) + +rgb[2]).toString(16).slice(1);
    }

    // LOAD/SAVE
    function loadHabits() {
      habits = JSON.parse(localStorage.getItem(habitsKey) || '[]');
      renderHabits();
      renderAnalytics();
    }
    function saveHabits() {
      localStorage.setItem(habitsKey, JSON.stringify(habits));
      renderAnalytics();
    }

    // HABIT MANAGE
    function addHabit(name, cat, color) {
      if (!name.trim()) return;
      habits.push({
        name,
        cat,
        color,
        days: {}
      });
      saveHabits();
      renderHabits();
    }
    function deleteHabit(idx) {
      if (confirm('Delete this habit?')) {
        habits.splice(idx, 1);
        saveHabits();
        renderHabits();
      }
    }
    function resetHabit(idx) {
      if (confirm('Reset all progress for this habit?')) {
        habits[idx].days = {};
        saveHabits();
        renderHabits();
      }
    }
    function resetAllHabits() {
      if (confirm('Reset ALL progress for ALL habits?')) {
        habits.forEach(h => h.days = {});
        saveHabits();
        renderHabits();
      }
    }
    function toggleHabitDay(idx, date) {
      let days = habits[idx].days;
      if (days[date]) {
        delete days[date];
      } else {
        days[date] = true;
      }
      saveHabits();
      renderHabits();
    }

    // Sparkline chart for each habit
    function renderSparkline(daysObj, color="#387ef5", daysCount=21) {
      const dates = getPastDays(daysCount);
      let points = dates.map(d => daysObj[d]?1:0);
      let w = daysCount*7, h = 20;
      let pl = points.map((v,i)=>`${i*7},${h-(v*15)}`).join(' ');
      let svg = `<svg class="sparkline" width="${w}" height="${h}" style="display:block;">
        <polyline points="${pl}" fill="none" stroke="${color}" stroke-width="2"/>
        ${points.map((v, i) => v ? `<circle cx="${i*7}" cy="${h-15}" r="2" fill="#8ed18e"/>` : '').join('')}
      </svg>`;
      return svg;
    }

    // DATES AND STREAKS
    function getPastDays(n) {
      const arr = [];
      for (let i=n-1; i>=0; i--) {
        const d = new Date();
        d.setDate(d.getDate()-i);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }
    function calcStreak(daysObj) {
      const daysArr = Object.keys(daysObj).sort((a,b)=>a>b?1:-1);
      if (daysArr.length === 0) return 0;
      let streak = 0;
      let today = new Date().toISOString().slice(0,10);
      let d = new Date(today);
      while(daysObj[d.toISOString().slice(0,10)]) {
        streak++;
        d.setDate(d.getDate()-1);
      }
      return streak;
    }
    function calcLongestStreak(daysObj) {
      const dates = Object.keys(daysObj).sort();
      let max = 0, curr = 0, lastDate = null;
      dates.forEach(date => {
        if (!lastDate) { curr = 1; }
        else {
          const d1 = new Date(lastDate), d2 = new Date(date);
          if ((d2 - d1) / (1000*60*60*24) === 1) curr++;
          else curr = 1;
        }
        if (curr > max) max = curr;
        lastDate = date;
      });
      return max;
    }
    function getTotalTracked(daysObj) {
      return Object.keys(daysObj).length;
    }
    function getAvgStreak(daysObj) {
      // For the average streak, find all streaks
      const dates = Object.keys(daysObj).sort();
      let streaks = [], curr = 0, lastDate = null;
      dates.forEach(date => {
        if (!lastDate) { curr = 1; }
        else {
          const d1 = new Date(lastDate), d2 = new Date(date);
          if ((d2 - d1) / (1000*60*60*24) === 1) curr++;
          else { streaks.push(curr); curr = 1; }
        }
        lastDate = date;
      });
      if (curr > 0) streaks.push(curr);
      if (streaks.length === 0) return 0;
      return (streaks.reduce((a,b)=>a+b,0)/streaks.length).toFixed(2);
    }

    // RENDER HABITS
    function renderHabits() {
      const list = document.getElementById('habits-list');
      list.innerHTML = '';
      if (habits.length === 0) {
        list.innerHTML = '<div style="color:#888">No habits yet. Add the first one above!</div>';
        return;
      }
      habits.forEach((habit, idx) => {
        const habitDiv = document.createElement('div');
        habitDiv.className = 'habit-card';
        habitDiv.innerHTML = `
          <div>
            <span class="habit-title" style="color:${habit.color||'var(--accent)'}">${habit.name}</span>
            <span class="habit-cat" style="background:${habit.color||'#eee'};color:#fff;">${habit.cat||'Other'}</span>
            <button class="delete-btn" onclick="deleteHabit(${idx})">Delete</button>
            <button class="reset-btn" onclick="resetHabit(${idx})">Reset</button>
          </div>
          <div class="streak">Current streak: <span style="color:green">${calcStreak(habit.days)}</span> days |
            Longest: <span style="color:#387ef5">${calcLongestStreak(habit.days)}</span> |
            Total: <span style="color:#666">${getTotalTracked(habit.days)}</span>
          </div>
          ${renderSparkline(habit.days, habit.color)}
          <div class="calendar-row" id="cal-${idx}"></div>
        `;
        list.appendChild(habitDiv);

        // Render calendar
        const cal = document.getElementById(`cal-${idx}`);
        const past = getPastDays(21); // Last 21 days
        past.forEach(date => {
          const cell = document.createElement('button');
          cell.className = 'cal-cell' + (habit.days[date] ? ' done':'');
          cell.style.background = habit.days[date] ? (habit.color||'var(--accent)') : '';
          cell.textContent = date.slice(8,10); // Show day
          cell.title = date;
          cell.onclick = () => { toggleHabitDay(idx, date); };
          cal.appendChild(cell);
        });
      });
    }

    // ANALYTICS
    function renderAnalytics() {
      const el = document.getElementById('analytics');
      if (habits.length === 0) {
        el.innerHTML = '';
        return;
      }
      let totalDays = habits.reduce((s,h)=>s+getTotalTracked(h.days),0);
      let avgStreaks = habits.map(h => getAvgStreak(h.days));
      let summary = `<div><strong>Total habits:</strong> ${habits.length}</div>
      <div><strong>Total days tracked:</strong> ${totalDays}</div>
      <div><strong>Average streak per habit:</strong> ${avgStreaks.length ? (avgStreaks.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/avgStreaks.length).toFixed(2) : 0} days</div>`;
      habits.forEach(h => {
        summary += `<div><b>${h.name}</b> (<span style="background:${h.color||'#eee'};color:#fff;padding:0 7px;border-radius:5px;">${h.cat||'Other'}</span>): Current streak <span style="color:green">${calcStreak(h.days)}</span> | Longest <span style="color:#387ef5">${calcLongestStreak(h.days)}</span> | Average streak <span style="color:#227">${getAvgStreak(h.days)}</span></div>`;
      });
      el.innerHTML = `<h3>Habit Analytics</h3>${summary}`;
    }

    // EXPORT CSV
    function exportCSV() {
      const rows = [["Habit","Category","Color","Date"]];
      habits.forEach(h => {
        Object.keys(h.days).forEach(d => rows.push([h.name, h.cat||'Other', h.color||'', d]));
      });
      const csv = rows.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url; link.download = "habits.csv";
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    // IMPORT CSV
    document.getElementById('csv-import').onchange = function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(evt) {
        let lines = evt.target.result.trim().split("\n");
        let newHabits = {};
        for (let i=1; i<lines.length; ++i) {
          let [name, cat, color, date] = lines[i].split(",");
          let key = name + cat + color;
          if (!newHabits[key]) newHabits[key] = { name, cat, color, days:{} };
          newHabits[key].days[date] = true;
        }
        // Merge imported habits with existing
        Object.values(newHabits).forEach(himp => {
          let idx = habits.findIndex(h => h.name === himp.name && h.cat === himp.cat && h.color === himp.color);
          if (idx > -1) Object.assign(habits[idx].days, himp.days);
          else habits.push(himp);
        });
        saveHabits();
        renderHabits();
        alert("Imported successfully!");
        e.target.value = "";
      };
      reader.readAsText(file);
    };

    // REMINDERS
    function setReminder() {
      let hour = prompt("Set daily reminder hour (0-23)", "19");
      if (!hour || isNaN(hour) || hour < 0 || hour > 23) return alert("Invalid hour!");
      localStorage.setItem("habit_reminder_hour", hour);
      Notification.requestPermission().then(status => {
        if(status==="granted") {
          alert("Reminder will try to notify daily at "+hour+":00.");
        } else {
          alert("Can't send notifications without permission.");
        }
      });
    }
    // Reminder logic with local scheduler (works if tab is open)
    setInterval(() => {
      // Only notify if permission
      if(Notification.permission!=="granted") return;
      let hour = +localStorage.getItem("habit_reminder_hour");
      if(isNaN(hour)) return;
      let now = new Date();
      if(now.getHours()===hour && now.getMinutes()===0 && now.getSeconds()<5){
        new Notification("Habit Tracker: Time to update your progress! üí™");
      }
    }, 3500);

    // ADD FORM AND ACTIONS
    document.getElementById('add-form').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('habit-input').value;
      const cat = document.getElementById('cat-input').value;
      const color = document.getElementById('custom-color').value;
      addHabit(name, cat, color);
      document.getElementById('habit-input').value = '';
      document.getElementById('cat-input').value = 'Health';
      document.getElementById('custom-color').value = "#52a7e7";
    };

    // Globals for calendar actions
    window.deleteHabit = deleteHabit;
    window.toggleHabitDay = toggleHabitDay;
    window.resetHabit = resetHabit;
    window.resetAllHabits = resetAllHabits;
    window.exportCSV = exportCSV;

    loadHabits();
  </script>
</body>
</html>
